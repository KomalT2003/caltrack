<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CalTrack</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen flex justify-center" id="appBody">

  <!-- Background art layer (set by JS) -->
  <div id="bgArt" class="pointer-events-none fixed inset-0"></div>

  <!-- Login Screen -->
  <div id="loginScreen" class="hidden w-full max-w-[430px] min-h-screen px-6 flex items-center justify-center relative z-10">
    <div class="w-full bg-white/10 backdrop-blur-xl rounded-3xl p-8 shadow-2xl border border-white/20">
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">üçΩÔ∏è</div>
        <div class="text-white font-bold text-4xl mb-2">CalTrack</div>
        <div class="text-white/70 font-light text-sm">Track your calories with AI</div>
      </div>

      <div id="loginForm" class="space-y-4">
        <div>
          <input id="loginUsername" type="text" placeholder="Username" class="w-full bg-white/20 text-white placeholder-white/60 border border-white/30 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-white/50 font-light" />
        </div>
        <div>
          <input id="loginPassword" type="password" placeholder="Password" class="w-full bg-white/20 text-white placeholder-white/60 border border-white/30 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-white/50 font-light" />
        </div>
        <div id="loginError" class="hidden text-red-300 text-sm font-light text-center p-2 bg-red-900/30 rounded-xl"></div>
        <button id="loginBtn" class="w-full bg-white text-gray-900 rounded-2xl px-4 py-3 font-light hover:bg-white/90 transition-all">
          Login
        </button>
        <button id="showRegisterBtn" class="w-full bg-white/10 text-white border border-white/30 rounded-2xl px-4 py-3 font-light hover:bg-white/20 transition-all">
          Create Account
        </button>
      </div>

      <div id="registerForm" class="hidden space-y-4">
        <div>
          <input id="registerUsername" type="text" placeholder="Choose username (min 3 characters)" class="w-full bg-white/20 text-white placeholder-white/60 border border-white/30 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-white/50 font-light" />
        </div>
        <div>
          <input id="registerPassword" type="password" placeholder="Choose password (min 4 characters)" class="w-full bg-white/20 text-white placeholder-white/60 border border-white/30 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-white/50 font-light" />
        </div>
        <div id="registerError" class="hidden text-red-300 text-sm font-light text-center p-2 bg-red-900/30 rounded-xl"></div>
        <button id="registerBtn" class="w-full bg-white text-gray-900 rounded-2xl px-4 py-3 font-light hover:bg-white/90 transition-all">
          Create Account
        </button>
        <button id="showLoginBtn" class="w-full bg-white/10 text-white border border-white/30 rounded-2xl px-4 py-3 font-light hover:bg-white/20 transition-all">
          Back to Login
        </button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="hidden w-full max-w-[430px] min-h-screen px-6 pt-8 pb-32 relative z-10" id="phoneShell">
    <!-- Header row: calories (left), time + location (right) -->
    <div class="flex items-center justify-between mb-8">
      <div class="text-left">
        <div class="text-white/80 text-xs uppercase tracking-widest font-light mb-2">Calories</div>
        <div class="text-white font-bold text-6xl" style="line-height: 1.1;"><span id="totalKcalSmall">0</span></div>
      </div>
      <div class="text-right leading-tight">
        <div class="text-white font-bold text-6xl tracking-tight mb-1" style="line-height: 1.1;" id="timeText">--:--</div>
        <div class="text-white/90 text-xl font-light flex items-center justify-end gap-2">
          <span id="todayLabel">Today</span>
          <span class="text-white/60">‚Ä¢</span>
          <span id="locationText">üìç Delhi</span>
        </div>
      </div>
    </div>

    <!-- User info bar -->
    <div class="flex items-center justify-between mb-6 pb-4 border-b border-white/10">
      <div class="text-white/70 font-light text-sm">üë§ <span id="currentUser">User</span></div>
      <button id="logoutBtn" class="text-white/70 hover:text-white text-xs font-light px-3 py-1 rounded-lg hover:bg-white/10 transition-colors">Logout</button>
    </div>

    <!-- Today list -->
    <div class="relative" style="max-height: calc(100vh - 420px); overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;">
      <div id="mealsHeader" class="flex items-center justify-between mb-4 sticky top-0 bg-gradient-to-b from-black/80 to-transparent pt-2 pb-4 z-10 backdrop-blur-sm">
        <div class="text-white font-light text-xl">Today's Meals</div>
        <button id="clearTodayBtn" class="text-white/70 text-sm hover:text-white transition-colors px-3 py-1 rounded-lg hover:bg-white/10 font-light">Clear All</button>
      </div>
      <div id="todayList" class="space-y-2 pb-4"></div>
      <div id="emptyState" class="fixed inset-0 flex flex-col items-center justify-center text-center text-white/60 text-sm hidden z-0">
        <div class="text-5xl mb-3">üçΩÔ∏è</div>
        <div class="text-base font-light">No meals logged yet</div>
        <div class="text-xs mt-2 text-white/50 font-light">Tap "Add Meal" to get started</div>
      </div>
    </div>
  </div>

  <!-- Bottom Action Buttons -->
  <div class="fixed bottom-8 left-1/2 -translate-x-1/2 flex gap-4 z-20">
    <button id="openCalendarBtn" class="glass-button text-white shadow-2xl p-4 rounded-full font-light text-2xl w-14 h-14 flex items-center justify-center">
      üìÖ
    </button>
    <button id="openAddBtn" class="glass-button text-white shadow-2xl px-6 py-4 rounded-full font-light text-base whitespace-nowrap">
      + Add Meal
    </button>
  </div>

  <!-- Add Modal -->
  <div id="addModal" class="hidden fixed inset-0 bg-black/60 z-30">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-[430px] bg-white rounded-3xl p-6 shadow-2xl">
        <div class="flex items-center justify-between mb-5">
          <div class="font-light text-2xl text-gray-900">Add Meal</div>
          <button id="closeAddBtn" class="text-gray-400 hover:text-gray-900 text-2xl leading-none">√ó</button>
        </div>

        <div class="mt-4">
          <label class="text-sm font-light text-gray-600">What did you eat?</label>
          <div class="mt-2 flex gap-2">
            <input id="foodInput" class="flex-1 border border-gray-300 rounded-2xl px-4 py-3 focus:outline-none focus:ring-1 focus:ring-gray-400 focus:border-transparent font-light" placeholder="e.g., 4 spoons of dal chawal" />
            <button id="micBtn" class="border border-gray-300 rounded-2xl px-4 py-3 hover:bg-gray-50 transition-colors" title="Speak">üé§</button>
          </div>
          <div class="mt-2 text-xs text-gray-500 font-light" id="speechHint">üí° You can type or use voice input</div>
        </div>

        <div class="mt-6 p-4 bg-gray-50 rounded-2xl">
          <div class="flex items-center justify-between gap-3">
            <button id="estimateBtn" class="flex-1 bg-gray-900 text-white rounded-xl px-5 py-3 font-light disabled:opacity-50 hover:bg-gray-800 transition-all">
              ‚ú® Estimate Calories
            </button>
            <div class="text-right">
              <div class="text-xs text-gray-500 font-light">Estimated</div>
              <div class="text-3xl font-light text-gray-900"><span id="estimatedKcal">‚Äî</span></div>
              <div class="text-xs text-gray-500 font-light">kcal</div>
            </div>
          </div>
        </div>

        <div class="mt-4 p-3 rounded-xl bg-gray-100 text-sm text-gray-700 font-light hidden" id="llmNote"></div>
        <div class="mt-3 p-3 rounded-xl bg-red-50 text-sm text-red-700 font-light hidden" id="llmError"></div>

        <div class="mt-6 flex gap-3">
          <button id="cancelBtn" class="flex-1 border border-gray-300 rounded-xl px-4 py-3 font-light text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
          <button id="addBtn" class="flex-1 bg-gray-900 text-white rounded-xl px-4 py-3 font-light disabled:opacity-50 disabled:bg-gray-400 hover:bg-gray-800 transition-all" disabled>Add to Today</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Modal -->
  <div id="calendarModal" class="hidden fixed inset-0 bg-black/60 z-30">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-[430px] bg-white rounded-3xl p-6 shadow-2xl max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-5">
          <div class="font-light text-2xl text-gray-900" id="calendarMonthYear">January 2026</div>
          <button id="closeCalendarBtn" class="text-gray-400 hover:text-gray-900 text-2xl leading-none">√ó</button>
        </div>

        <div class="mb-4 text-sm text-gray-500 font-light">Monthly calorie summary</div>

        <!-- Calendar Grid -->
        <div class="grid grid-cols-7 gap-2" id="calendarGrid">
          <!-- Day headers -->
          <div class="text-center text-xs font-light text-gray-500 py-2">Sun</div>
          <div class="text-center text-xs font-light text-gray-500 py-2">Mon</div>
          <div class="text-center text-xs font-light text-gray-500 py-2">Tue</div>
          <div class="text-center text-xs font-light text-gray-500 py-2">Wed</div>
          <div class="text-center text-xs font-light text-gray-500 py-2">Thu</div>
          <div class="text-center text-xs font-light text-gray-500 py-2">Fri</div>
          <div class="text-center text-xs font-light text-gray-500 py-2">Sat</div>
          <!-- Days will be inserted by JS -->
        </div>

        <div class="mt-6 p-4 bg-gray-50 rounded-2xl">
          <div class="flex justify-between items-center">
            <div class="text-sm font-light text-gray-600">Total this month</div>
            <div class="text-2xl font-bold text-gray-900"><span id="monthTotal">0</span> kcal</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    #appBody {
      background: #000;
      position: relative;
      overflow: hidden;
    }
    #bgArt {
      position: fixed;
      inset: 0;
      z-index: 0;
      background-size: cover;
      background-position: center;
    }
    #bgArt::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.6) 100%);
      z-index: 1;
    }
    #phoneShell {
      position: relative;
      z-index: 10;
      animation: fadeIn 0.8s ease-out;
    }
    .cardRow {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      backdrop-filter: blur(30px) saturate(180%);
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      animation: slideUp 0.5s ease-out;
    }
    .cardRow:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
      border-color: rgba(255,255,255,0.3);
    }
    .glass-button {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.3);
      transition: all 0.3s ease;
    }
    .glass-button:hover {
      background: rgba(255,255,255,0.25);
      transform: scale(1.05);
    }
    .glass-button:active {
      transform: scale(0.98);
    }
    /* Custom scrollbar styling */
    ::-webkit-scrollbar {
      width: 6px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255,255,255,0.3);
    }
  </style>

  <script>
    const API_BASE = window.location.origin;
    let currentUser = null;
    let userCity = "Loading...";
    let userCityFull = "";

    const el = {
      body: document.getElementById("appBody"),
      bgArt: document.getElementById("bgArt"),
      locationText: document.getElementById("locationText"),
      
      // Login elements
      loginScreen: document.getElementById("loginScreen"),
      loginForm: document.getElementById("loginForm"),
      registerForm: document.getElementById("registerForm"),
      loginUsername: document.getElementById("loginUsername"),
      loginPassword: document.getElementById("loginPassword"),
      loginBtn: document.getElementById("loginBtn"),
      loginError: document.getElementById("loginError"),
      registerUsername: document.getElementById("registerUsername"),
      registerPassword: document.getElementById("registerPassword"),
      registerBtn: document.getElementById("registerBtn"),
      registerError: document.getElementById("registerError"),
      showRegisterBtn: document.getElementById("showRegisterBtn"),
      showLoginBtn: document.getElementById("showLoginBtn"),
      
      // Main app elements
      phoneShell: document.getElementById("phoneShell"),
      currentUser: document.getElementById("currentUser"),
      logoutBtn: document.getElementById("logoutBtn"),
      todayLabel: document.getElementById("todayLabel"),
      timeText: document.getElementById("timeText"),
      totalKcalSmall: document.getElementById("totalKcalSmall"),
      todayList: document.getElementById("todayList"),
      emptyState: document.getElementById("emptyState"),
      mealsHeader: document.getElementById("mealsHeader"),
      clearTodayBtn: document.getElementById("clearTodayBtn"),

      openAddBtn: document.getElementById("openAddBtn"),
      addModal: document.getElementById("addModal"),
      closeAddBtn: document.getElementById("closeAddBtn"),
      cancelBtn: document.getElementById("cancelBtn"),
      foodInput: document.getElementById("foodInput"),
      micBtn: document.getElementById("micBtn"),
      speechHint: document.getElementById("speechHint"),
      estimateBtn: document.getElementById("estimateBtn"),
      estimatedKcal: document.getElementById("estimatedKcal"),
      llmNote: document.getElementById("llmNote"),
      llmError: document.getElementById("llmError"),
      addBtn: document.getElementById("addBtn"),

      openCalendarBtn: document.getElementById("openCalendarBtn"),
      calendarModal: document.getElementById("calendarModal"),
      closeCalendarBtn: document.getElementById("closeCalendarBtn"),
      calendarMonthYear: document.getElementById("calendarMonthYear"),
      calendarGrid: document.getElementById("calendarGrid"),
      monthTotal: document.getElementById("monthTotal"),
    };

    // API Helper
    async function apiCall(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          }
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error || 'Request failed');
        }
        return data;
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // Auth functions
    async function checkAuth() {
      try {
        const data = await apiCall('/api/auth/check');
        if (data.authenticated) {
          currentUser = data.username;
          showApp();
          return true;
        }
      } catch (error) {
        console.log('Not authenticated');
      }
      showLogin();
      return false;
    }

    function showLogin() {
      el.loginScreen.classList.remove('hidden');
      el.phoneShell.classList.add('hidden');
      el.loginForm.classList.remove('hidden');
      el.registerForm.classList.add('hidden');
    }

    function showRegister() {
      el.loginForm.classList.add('hidden');
      el.registerForm.classList.remove('hidden');
      el.registerError.classList.add('hidden');
    }

    function showLoginForm() {
      el.loginForm.classList.remove('hidden');
      el.registerForm.classList.add('hidden');
      el.loginError.classList.add('hidden');
    }

    function showApp() {
      el.loginScreen.classList.add('hidden');
      el.phoneShell.classList.remove('hidden');
      el.currentUser.textContent = currentUser || 'User';
      loadMeals();
    }

    // Login/Register handlers
    el.loginBtn.addEventListener('click', async () => {
      const username = el.loginUsername.value.trim();
      const password = el.loginPassword.value.trim();
      
      if (!username || !password) {
        el.loginError.textContent = 'Please enter username and password';
        el.loginError.classList.remove('hidden');
        return;
      }
      
      try {
        el.loginBtn.disabled = true;
        el.loginBtn.textContent = 'Logging in...';
        await apiCall('/api/auth/login', {
          method: 'POST',
          body: JSON.stringify({ username, password })
        });
        currentUser = username;
        showApp();
      } catch (error) {
        el.loginError.textContent = error.message;
        el.loginError.classList.remove('hidden');
      } finally {
        el.loginBtn.disabled = false;
        el.loginBtn.textContent = 'Login';
      }
    });

    el.registerBtn.addEventListener('click', async () => {
      const username = el.registerUsername.value.trim();
      const password = el.registerPassword.value.trim();
      
      if (!username || !password) {
        el.registerError.textContent = 'Please enter username and password';
        el.registerError.classList.remove('hidden');
        return;
      }
      
      try {
        el.registerBtn.disabled = true;
        el.registerBtn.textContent = 'Creating account...';
        await apiCall('/api/auth/register', {
          method: 'POST',
          body: JSON.stringify({ username, password })
        });
        currentUser = username;
        showApp();
      } catch (error) {
        el.registerError.textContent = error.message;
        el.registerError.classList.remove('hidden');
      } finally {
        el.registerBtn.disabled = false;
        el.registerBtn.textContent = 'Create Account';
      }
    });

    el.showRegisterBtn.addEventListener('click', showRegister);
    el.showLoginBtn.addEventListener('click', showLoginForm);

    el.logoutBtn.addEventListener('click', async () => {
      try {
        await apiCall('/api/auth/logout', { method: 'POST' });
        currentUser = null;
        showLogin();
      } catch (error) {
        console.error('Logout error:', error);
      }
    });

    // Enter key handlers
    el.loginPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') el.loginBtn.click();
    });
    el.registerPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') el.registerBtn.click();
    });

    function pad2(n) { return String(n).padStart(2, "0"); }

    function todayKeyLocal() {
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    }

    function formatTodayLabel() {
      const d = new Date();
      return d.toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" });
    }

    let todayMeals = [];

    async function loadMeals() {
      try {
        const data = await apiCall(`/api/meals?date=${todayKeyLocal()}`);
        todayMeals = data.meals || [];
        render();
      } catch (error) {
        console.error('Error loading meals:', error);
        todayMeals = [];
        render();
      }
    }

    function getTimeOfDay() {
      const h = new Date().getHours();
      if (h >= 5 && h < 11) return "morning";
      if (h >= 11 && h < 17) return "day";
      if (h >= 17 && h < 20) return "evening";
      return "night";
    }

    // Get user's location and city name
    async function getUserLocation() {
      try {
        // Request geolocation permission
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject);
        });

        const { latitude, longitude } = position.coords;
        
        // Reverse geocoding using Nominatim (OpenStreetMap - free, no API key needed)
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`,
          {
            headers: {
              'User-Agent': 'CalTrack-App'
            }
          }
        );
        
        const data = await response.json();
        const address = data.address || {};
        
        // Get city name (try multiple fields)
        userCity = address.city || address.town || address.village || address.county || "Your City";
        userCityFull = `${userCity}, ${address.state || address.country || ''}`.trim().replace(/, $/, '');
        
        console.log(`üìç Location detected: ${userCityFull}`);
        
        // Update UI
        el.locationText.textContent = `üìç ${userCity}`;
        
        // Update background with new city
        setTimeOfDayBackground();
        
      } catch (error) {
        console.log('Location access denied or unavailable:', error);
        userCity = "India";
        userCityFull = "India";
        el.locationText.textContent = `üìç ${userCity}`;
      }
    }

    function setTimeOfDayBackground() {
      const tod = getTimeOfDay();
      const bgStyle = buildBackgroundSvg(tod);
      el.bgArt.style.cssText = bgStyle;
    }

    function buildBackgroundSvg(tod) {
      // Use city name for background search
      const cityForSearch = userCity !== "Loading..." ? userCity : "India";
      
      // Time-of-day overlays
      const overlays = {
        morning: 'rgba(0,0,0,0.3), rgba(0,0,0,0.5)',
        day: 'rgba(0,0,0,0.25), rgba(0,0,0,0.45)',
        evening: 'rgba(0,0,0,0.35), rgba(0,0,0,0.55)',
        night: 'rgba(0,0,0,0.45), rgba(0,0,0,0.65)'
      };
      
      const overlay = overlays[tod] || overlays.day;
      
      // Use Unsplash Source API for dynamic city images
      const bgUrl = `https://source.unsplash.com/1200x1600/?${encodeURIComponent(cityForSearch)},city,landmark`;
      
      return `background: linear-gradient(${overlay}), url('${bgUrl}') center/cover no-repeat;`;
    }

    function computeTotal(items) {
      return items.reduce((sum, it) => sum + (Number(it.calories) || 0), 0);
    }

    function render() {
      el.todayLabel.textContent = formatTodayLabel();
      const items = todayMeals;
      const total = computeTotal(items);

      el.totalKcalSmall.textContent = String(total);
      el.todayList.innerHTML = "";

      if (items.length === 0) {
        el.emptyState.classList.remove("hidden");
        el.mealsHeader.classList.add("hidden");
      } else {
        el.emptyState.classList.add("hidden");
        el.mealsHeader.classList.remove("hidden");
      }

      for (const item of items.slice().reverse()) {
        const row = document.createElement("div");
        row.className = "cardRow rounded-2xl px-5 py-4 flex items-center justify-between cursor-pointer";
        const timeStr = item.created_at ? new Date(item.created_at).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }) : '';
        row.innerHTML = `
          <div class="min-w-0 flex-1 pr-4">
            <div class="text-white font-light text-lg truncate" style="line-height: 1.4;">${escapeHtml(item.food_description || "Food")}</div>
            <div class="text-white/70 text-xs mt-1 font-light">${timeStr}</div>
          </div>
          <div class="text-right">
            <div class="text-white font-thin text-3xl whitespace-nowrap" style="line-height: 1.2;">${Number(item.calories) || 0}</div>
            <div class="text-white/70 text-xs font-light">kcal</div>
          </div>
        `;
        el.todayList.appendChild(row);
      }
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function openModal() {
      el.addModal.classList.remove("hidden");
      el.foodInput.focus();
    }

    function closeModal() {
      el.addModal.classList.add("hidden");
      el.foodInput.value = "";
      el.estimatedKcal.textContent = "‚Äî";
      el.addBtn.disabled = true;
      el.llmError.classList.add("hidden");
      el.llmError.textContent = "";
      el.llmNote.classList.add("hidden");
      el.llmNote.textContent = "";
    }

    async function estimateWithLLM(text) {
      const apiBase = location.protocol === "file:" ? "http://127.0.0.1:8787" : "";
      try {
        const res = await fetch(`${apiBase}/api/estimate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data?.error || data?.details || "Failed to estimate calories. Make sure the backend server is running.";
          throw new Error(msg);
        }
        return data;
      } catch (err) {
        if (err.message.includes('fetch')) {
          throw new Error("Cannot connect to server. Please start the backend: cd backend && python app.py");
        }
        throw err;
      }
    }

    function updateTime() {
      const now = new Date();
      const time = now.toLocaleTimeString(undefined, { hour: 'numeric', minute: '2-digit', hour12: true });
      const parts = time.split(' ');
      if (parts.length === 2) {
        el.timeText.innerHTML = `${parts[0]}<span style="font-size: 0.35em; opacity: 0.7; margin-left: 0.2em; vertical-align: super;">${parts[1]}</span>`;
      } else {
        el.timeText.textContent = time;
      }
    }

    // Speech Recognition (browser API)
    function getSpeechRecognition() {
      return window.SpeechRecognition || window.webkitSpeechRecognition || null;
    }

    function startSpeechOnce() {
      const SR = getSpeechRecognition();
      if (!SR) {
        el.speechHint.textContent = "Speech not supported in this browser.";
        return;
      }

      const rec = new SR();
      rec.lang = "en-US";
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      el.micBtn.disabled = true;
      el.speechHint.textContent = "Listening‚Ä¶";

      rec.onresult = (event) => {
        const spoken = event.results?.[0]?.[0]?.transcript || "";
        if (spoken.trim()) el.foodInput.value = spoken.trim();
      };
      rec.onerror = () => {
        el.speechHint.textContent = "Couldn‚Äôt capture speech. Try again.";
      };
      rec.onend = () => {
        el.micBtn.disabled = false;
        el.speechHint.textContent = "Tip: you can type or speak.";
      };
      rec.start();
    }

    function openCalendarModal() {
      el.calendarModal.classList.remove("hidden");
      renderCalendar();
    }

    function closeCalendarModal() {
      el.calendarModal.classList.add("hidden");
    }

    async function renderCalendar() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      
      // Set month/year header
      el.calendarMonthYear.textContent = now.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
      
      // Get first day of month and total days
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // Get monthly data from backend
      let meals = {};
      try {
        const data = await apiCall(`/api/meals/month?year=${year}&month=${month + 1}`);
        meals = data.meals || {};
      } catch (error) {
        console.error('Error loading calendar:', error);
      }
      
      const today = todayKeyLocal();
      
      // Find existing day headers
      const headers = el.calendarGrid.querySelectorAll('.text-gray-500');
      
      // Remove old day cells (keep headers)
      const oldCells = el.calendarGrid.querySelectorAll('.day-cell');
      oldCells.forEach(cell => cell.remove());
      
      // Add empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div');
        empty.className = 'day-cell';
        el.calendarGrid.appendChild(empty);
      }
      
      // Add day cells
      let monthTotalCals = 0;
      for (let day = 1; day <= daysInMonth; day++) {
        const dateKey = `${year}-${pad2(month + 1)}-${pad2(day)}`;
        const calories = meals[dateKey] || 0;
        monthTotalCals += calories;
        
        const isToday = dateKey === today;
        
        const cell = document.createElement('div');
        cell.className = `day-cell p-2 rounded-xl text-center ${isToday ? 'bg-gray-900 text-white' : calories > 0 ? 'bg-gray-100' : ''}`;
        cell.innerHTML = `
          <div class="text-sm font-light ${isToday ? 'font-bold' : ''}">${day}</div>
          ${calories > 0 ? `<div class="text-xs mt-1 ${isToday ? 'text-white/80' : 'text-gray-600'}">${calories}</div>` : ''}
        `;
        el.calendarGrid.appendChild(cell);
      }
      
      el.monthTotal.textContent = monthTotalCals;
    }

    // Wire UI
    el.openAddBtn.addEventListener("click", openModal);
    el.closeAddBtn.addEventListener("click", closeModal);
    el.cancelBtn.addEventListener("click", closeModal);
    el.addModal.addEventListener("click", (e) => {
      if (e.target === el.addModal) closeModal();
    });

    el.openCalendarBtn.addEventListener("click", openCalendarModal);
    el.closeCalendarBtn.addEventListener("click", closeCalendarModal);
    el.calendarModal.addEventListener("click", (e) => {
      if (e.target === el.calendarModal) closeCalendarModal();
    });

    el.micBtn.addEventListener("click", startSpeechOnce);

    el.estimateBtn.addEventListener("click", async () => {
      const text = el.foodInput.value.trim();
      el.llmError.classList.add("hidden");
      el.llmError.textContent = "";
      el.llmNote.classList.add("hidden");
      el.llmNote.textContent = "";

      if (!text) {
        el.llmError.textContent = "Type or speak something first.";
        el.llmError.classList.remove("hidden");
        return;
      }

      el.estimateBtn.disabled = true;
      el.estimateBtn.textContent = "Estimating‚Ä¶";
      try {
        const out = await estimateWithLLM(text);
        const kcal = Number(out?.calories);
        if (!Number.isFinite(kcal)) throw new Error("LLM returned an invalid calorie value.");

        el.estimatedKcal.textContent = String(Math.max(0, Math.round(kcal)));
        el.addBtn.disabled = false;
        if (out?.notes) {
          el.llmNote.textContent = String(out.notes);
          el.llmNote.classList.remove("hidden");
        }
      } catch (err) {
        el.llmError.textContent = err?.message || "Failed to estimate.";
        el.llmError.classList.remove("hidden");
        el.addBtn.disabled = true;
      } finally {
        el.estimateBtn.disabled = false;
        el.estimateBtn.textContent = "Estimate calories";
      }
    });

    el.addBtn.addEventListener("click", async () => {
      const text = el.foodInput.value.trim();
      const calories = Number(el.estimatedKcal.textContent);
      const notes = el.llmNote.textContent;
      if (!text || !Number.isFinite(calories)) return;

      try {
        el.addBtn.disabled = true;
        el.addBtn.textContent = 'Adding...';
        await apiCall('/api/meals', {
          method: 'POST',
          body: JSON.stringify({
            date: todayKeyLocal(),
            food_description: text,
            calories: Math.max(0, Math.round(calories)),
            notes: notes
          })
        });
        closeModal();
        await loadMeals();
      } catch (error) {
        el.llmError.textContent = error.message;
        el.llmError.classList.remove('hidden');
      } finally {
        el.addBtn.disabled = false;
        el.addBtn.textContent = 'Add to Today';
      }
    });

    el.clearTodayBtn.addEventListener("click", async () => {
      if (!confirm('Clear all meals for today?')) return;
      try {
        await apiCall(`/api/meals/clear?date=${todayKeyLocal()}`, { method: 'DELETE' });
        await loadMeals();
      } catch (error) {
        console.error('Error clearing meals:', error);
      }
    });

    // Init
    getUserLocation(); // Get user's actual location
    setTimeOfDayBackground();
    checkAuth();
    updateTime();
    setInterval(() => {
      setTimeOfDayBackground();
      updateTime();
    }, 60_000);
  </script>

</body>
</html>
